name: Validate config

on:
    push:
        branches: [main, frontend-main-app-auth]
    pull_request:
        branches: [main, frontend-main-app-auth]
    workflow_dispatch:

jobs:
    validate:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: Install dependencies
              run: |
                  cd FinanceFrontEnd/FinanceFunds
                  npm ci

            - name: Validate config
              env:
                  # Provide required production API URL from secrets (do not echo this value)
                  API_URL: ${{ secrets.API_URL }}
                  # Optional: set ALLOW_INSECURE_API to 'true' for staging if needed via repo secret
                  ALLOW_INSECURE_API: ${{ secrets.ALLOW_INSECURE_API }}
              run: |
                  # Run validator using secrets injected by the runner; avoid printing secrets in logs.
                  node ./.scripts/validate-config.js

    validate-staging:
        # Run this job only for staging/preview branches or manual dispatch
        if: |
            startsWith(github.ref, 'refs/heads/preview/') || github.ref == 'refs/heads/staging' || github.event_name == 'workflow_dispatch'
        runs-on: ubuntu-latest
        environment: staging
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: Install dependencies
              run: |
                  cd FinanceFrontEnd/FinanceFunds
                  npm ci

            - name: Validate config (staging/preview)
              # This job is pinned to the 'staging' environment so secrets must be granted there.
              env:
                  API_URL: ${{ secrets.API_URL }}
                  ALLOW_INSECURE_API: ${{ secrets.ALLOW_INSECURE_API }}
              run: |
                  node ./.scripts/validate-config.js
